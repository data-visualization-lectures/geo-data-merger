const SUPABASE_URL="https://vebhoeiltxspsurqoxvl.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlYmhvZWlsdHhzcHN1cnFveHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAyMjI2MTIsImV4cCI6MjA0NTc5ODYxMn0.sV-Xf6wP_m46D_q-XN0oZfK9NogDqD9xV5sS-n6J8c4",API_BASE_URL="https://api.dataviz.jp",AUTH_APP_URL="https://auth.dataviz.jp",AUTH_COOKIE_NAME="sb-dataviz-auth-token",COOKIE_MAX_AGE=31536e3,COOKIE_DOMAIN=(()=>{const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e||e.match(/^(\d{1,3}\.){3}\d{1,3}$/)?null:".dataviz.jp"})(),cookieStorage={getItem:e=>{const n=document.cookie.split(";").map(e=>e.trim()).reduce((e,n)=>{const[t,...a]=n.split("=");return e[t]=a.join("="),e},{});let t=n[e];if(!t){const a=[];let o=0;for(;n[`${e}.${o}`];)a.push(n[`${e}.${o}`]),o++;a.length>0&&(t=a.join(""))}if(!t)return null;try{return JSON.parse(t)}catch(e){}const a=decodeURIComponent(t);try{return JSON.parse(a)}catch(e){}try{let e=a.trim();e.startsWith("base64-")&&(e=e.slice(7));const n=e.replace(/-/g,"+").replace(/_/g,"/"),t=atob(n);return JSON.parse(t)}catch(e){console.error("[AuthDebug] All parse attempts failed for cookie",e)}return null},setItem:(e,n)=>{let t;try{t=btoa(n)}catch(e){return}let a=`${e}=${t}; Max-Age=31536000; Path=/; SameSite=Lax; Secure`;COOKIE_DOMAIN&&(a+=`; Domain=${COOKIE_DOMAIN}`),document.cookie=a},removeItem:e=>{const n=e=>{let n=`${e}=; Max-Age=0; Path=/; SameSite=Lax; Secure`;COOKIE_DOMAIN&&(n+=`; Domain=${COOKIE_DOMAIN}`),document.cookie=n};n(e),document.cookie.split(";").map(e=>e.trim().split("=")[0]).forEach(t=>{t.startsWith(`${e}.`)&&n(t)})}},supabase=window.supabase?window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY,{auth:{storage:cookieStorage,storageKey:AUTH_COOKIE_NAME,persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}):null;class DatavizGlobalHeader{constructor(){this.host=document.createElement("div"),this.host.id="dataviz-global-header-host",this.shadow=this.host.attachShadow({mode:"open"}),this.state={isLoading:!0,user:null}}mount(){const e=document.getElementById("dataviz-global-header-host");e&&e.remove(),document.body.prepend(this.host),this.render()}update(e){this.state={...this.state,...e},this.render()}getStyles(){return'\n      :host {\n        all: initial; /* 親スタイルの影響をリセット */\n        display: block;\n        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n        z-index: 99999;\n        position: relative;\n      }\n      .dv-header {\n        background-color: #111;\n        color: #ddd;\n        height: 48px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 0 16px;\n        font-size: 14px;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.3);\n      }\n      .dv-left {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n      }\n      .dv-brand {\n        font-weight: 700;\n        color: #fff;\n        text-decoration: none;\n        letter-spacing: 0.5px;\n      }\n      .dv-right {\n        display: flex;\n        align-items: center;\n        gap: 16px;\n      }\n      .dv-user-info {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        color: #aaa;\n      }\n      .dv-user-email {\n        white-space: nowrap;\n        color: inherit;\n        text-decoration: none;\n        cursor: pointer;\n      }\n      .dv-user-email:hover {\n        color: #fff;\n        text-decoration: underline;\n      }\n      .dv-btn {\n        background: transparent;\n        border: 1px solid #444;\n        color: #eee;\n        padding: 4px 10px;\n        border-radius: 4px;\n        text-decoration: none;\n        font-size: 12px;\n        cursor: pointer;\n        transition: background 0.2s, border-color 0.2s;\n      }\n      .dv-btn:hover {\n        background: #333;\n        border-color: #666;\n        color: #fff;\n      }\n      .dv-btn-primary {\n        background: #eee;\n        color: #111;\n        border-color: #eee;\n        font-weight: 600;\n      }\n      .dv-btn-primary:hover {\n        background: #fff;\n        color: #000;\n      }\n      .dv-loading {\n        opacity: 0.5;\n        font-size: 12px;\n      }\n      /* Mobile Optimizations */\n      @media (max-width: 600px) {\n        .dv-user-email { display: none; }\n      }\n    '}render(){const{isLoading:e,user:n}=this.state,t=`${AUTH_APP_URL}/account`,a=`${AUTH_APP_URL}/auth/login?redirect_to=${encodeURIComponent(window.location.href)}`;let o="";if(e)o='<span class="dv-loading">Loading...</span>';else if(n){const e=n.email||"User";o=`\n        <div class="dv-user-info">\n          <a href="${t}" class="dv-user-email" title="${e}">${e}</a>\n        </div>\n        <button class="dv-btn" id="dv-logout-btn">Log out</button>\n      `}else o=`\n        <span style="font-size:12px; color:#888;">Not logged in</span>\n        <a href="${a}" class="dv-btn dv-btn-primary">Log in</a>\n      `;this.shadow.innerHTML=`\n      <style>${this.getStyles()}</style>\n      <div class="dv-header">\n        <div class="dv-left">\n          <a href="${AUTH_APP_URL}" class="dv-brand">dataviz.jp</a>\n        </div>\n        <div class="dv-right">\n          ${o}\n        </div>\n      </div>\n    `;const i=this.shadow.getElementById("dv-logout-btn");i&&i.addEventListener("click",async()=>{confirm("ログアウトしますか？")&&(await supabase.auth.signOut(),window.location.reload())})}}function isAuthDebugMode(){return new URLSearchParams(window.location.search).has("auth_debug")}function performRedirect(e,n){isAuthDebugMode()?console.warn(`[dataviz-auth-client] Redirect suppressed. Reason: ${n} -> ${e}`):window.location.href=e}async function verifyUserAccess(e){if(!e){const e=encodeURIComponent(window.location.href);return performRedirect(`${AUTH_APP_URL}/auth/login?redirect_to=${e}`,"Unauthenticated"),null}try{const n=await fetch(`${API_BASE_URL}/api/me`,{method:"GET",headers:{Authorization:`Bearer ${e.access_token}`},credentials:"include"});if(!n.ok)throw new Error(`Status ${n.status}`);const t=await n.json(),a=t.subscription||{},o=a.status||"none",i=a.cancel_at_period_end;return"active"===o||"trialing"===o||i?{...t,email:e.user.email}:(performRedirect(`${AUTH_APP_URL}/account`,`Inactive Subscription (${o})`),null)}catch(e){return console.error("[dataviz-auth-client] Profile check failed",e),performRedirect(AUTH_APP_URL,"Profile Error"),null}}async function initDatavizToolAuth(){if(!supabase)return void console.error("[dataviz-auth-client] Supabase client missing.");const e=new DatavizGlobalHeader;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e.mount()):e.mount();let n=!1;const t=async n=>{const t=new URLSearchParams(window.location.hash.substring(1));if((new URLSearchParams(window.location.search).has("code")||t.has("access_token"))&&window.history.replaceState({},document.title,window.location.pathname),!n)return e.update({isLoading:!1,user:null}),void await verifyUserAccess(null);const a=await verifyUserAccess(n);a&&e.update({isLoading:!1,user:a})};supabase.auth.onAuthStateChange(async(e,a)=>{if("INITIAL_SESSION"===e){if(n)return;n=!0,await t(a)}else"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await t(a):"SIGNED_OUT"===e&&await t(null)});const{data:a}=await supabase.auth.getSession();n||(n=!0,await t(a.session))}initDatavizToolAuth(),window.supabase=supabase;